# 📋 مستندات موقت پروژه - گفتگوی یکپارچگی

## 🎯 **هدف این مستندات:**
ثبت برداشت‌ها، نکات مهم و تصمیمات در طول گفتگو برای رسیدن به درک مشترک و اقدام نهایی

---

## 📝 **برداشت‌های فعلی:**

### ✅ **وضعیت فعلی فرانت‌اند:**
- صفحه مدیریت رویدادها تا حد خوبی تکمیل شده
- فیلتر و جستجوی پیشرفته
- مودال‌های تأیید، رد، تسویه و ایجاد رویداد
- رابط کاربری مدرن و ریسپانسیو

### ⚠️ **مشکلات شناسایی شده:**
- محدودیت انعطاف‌پذیری ادمین در ایجاد رویدادهای پیچیده
- عدم پشتیبانی از گزینه‌های پویا (Dynamic Outcomes) در قالب‌ها

---

## 🔍 **نکات مهم برای بررسی:**

### 1. **معماری کلی سیستم**
- [x] ساختار API ها: API کاربران + API جدید ادمین
- [x] مدیریت state: حفظ ساختار فعلی
- [x] احراز هویت و مجوزها: میدل‌ور ادمین
- [x] ارتباط فرانت‌اند و بک‌اند: API های جداگانه

### 2. **اهداف و نیازمندی‌ها**
- [x] اهداف اصلی پروژه: پلتفرم شرط‌بندی با کیفیت بالا
- [x] نیازمندی‌های کاربران: قالب‌های استاندارد برای ایجاد رویداد
- [x] نیازمندی‌های ادمین: انعطاف‌پذیری کامل در مدیریت رویدادها
- [x] محدودیت‌های فنی: عدم پشتیبانی از گزینه‌های پویا
- [x] اولویت‌بندی ویژگی‌ها: توسعه سیستم قالب‌ها اولویت اول

### 3. **مشکلات و چالش‌ها**
- [x] مشکلات فعلی: محدودیت انعطاف‌پذیری ادمین در ایجاد رویدادهای پیچیده
- [x] چالش‌های پیش‌رو: تعادل بین استانداردسازی و انعطاف‌پذیری
- [x] راه‌حل‌های پیشنهادی: سیستم دوگانه (قالب + فرم آزاد) برای ادمین

### 4. **برنامه اقدام**
- [x] مراحل بعدی: پیاده‌سازی قوانین طلایی و API های جداگانه
- [x] اولویت‌بندی کارها: بک‌اند اول، سپس فرانت‌اند
- [x] اولویت قطعی: تکمیل سیستم قالب‌ها برای کاربران
- [ ] زمان‌بندی

---

## 📊 **یادداشت‌های گفتگو:**

### پیام 1: تحلیل طرح مسئله - انعطاف‌پذیری ادمین در مقابل ساختار کاربران

#### 🎯 **نکات مهم:**
- **تفاوت اساسی نقش‌ها**: کاربران نیاز به قالب‌های استاندارد، ادمین نیاز به انعطاف‌پذیری
- **محدودیت برای کاربران = مزیت**: قالب‌های استاندارد کیفیت محتوا را تضمین می‌کنند
- **انعطاف‌پذیری برای ادمین = ضرورت**: مدیریت رویدادهای پیچیده و خاص

#### 📋 **تصمیمات گرفته شده:**
- **حفظ قالب‌های استاندارد** برای کاربران
- **ایجاد سیستم دوگانه** برای ادمین: قالب + فرم آزاد
- **قدرت مطلق ادمین** در ایجاد و ویرایش رویدادها

#### 🔍 **سوالات باقی‌مانده:**
- جزئیات پیاده‌سازی فرم آزاد ادمین
- نحوه مدیریت ویرایش رویدادهای کاربران
- ساختار API برای رویدادهای سفارشی

### پیام 2: مرکز کنترل استراتژیک - خلاقیت در رویدادهای سفارشی

#### 🎯 **نکات مهم:**
- **انتقال از ابزار مدیریتی به مرکز کنترل استراتژیک**
- **سناریوهای خلاقانه**: رویدادهای چندمرحله‌ای، داده-محور، نامتقارن، مشارکتی
- **نیاز به تغییرات بک‌اند**: مدل‌های Event و Outcome

#### 📋 **تصمیمات گرفته شده:**
- **حفظ API فعلی کاربران** (POST /api/events)
- **ایجاد API جدید ادمین** (POST /api/admin/events/create-custom)
- **اضافه کردن فیلدهای جدید** به مدل‌ها

#### 🔧 **تغییرات فنی مورد نیاز:**

##### **مدل Event:**
- `resolutionSourceUrl: STRING` - لینک منبع داوری
- `isFeatured: BOOLEAN` - رویدادهای ویژه

##### **مدل Outcome:**
- `imageUrl: STRING` - تصویر برای هر گزینه
- `status: ENUM('ACTIVE', 'DISABLED')` - فعال/غیرفعال کردن گزینه‌ها

#### 🎨 **سناریوهای خلاقانه:**
1. **رویدادهای چندمرحله‌ای**: مدیریت گزینه‌های حذف شده
2. **رویدادهای داده-محور**: منبع داوری مشخص
3. **گزینه‌های نامتقارن**: شرط‌بندی پیچیده‌تر
4. **رویدادهای مشارکتی**: برندینگ و لوگو

### پیام 3: مدیریت تداخل داده و امنیت - قوانین طلایی

#### 🎯 **نکات مهم:**
- **مشکلات احتمالی**: تداخل داده، ویرایش‌های خطرناک، پیچیدگی و امنیت
- **نیاز به قوانین شفاف**: برای جلوگیری از باگ‌های جدی
- **جداسازی کامل**: API های کاربران و ادمین

#### 📋 **تصمیمات گرفته شده:**
- **اضافه کردن فیلد `isCustom: BOOLEAN`** به مدل Event
- **قانون طلایی**: ویرایش رویداد کاربر = تبدیل به سفارشی
- **API هوشمند**: بررسی وضعیت رویداد برای ویرایش

#### 🔧 **قوانین طلایی:**

##### **مشکل 1: تداخل داده**
- **راه‌حل**: فیلد `isCustom: BOOLEAN`
- **قانون**: ویرایش رویداد کاربر = `isCustom = true`

##### **مشکل 2: ویرایش‌های خطرناک**
- **PENDING_APPROVAL**: ویرایش کامل مجاز
- **ACTIVE**: فقط فیلدهای غیرحیاتی (imageUrl, isFeatured)

##### **مشکل 3: پیچیدگی و امنیت**
- **جداسازی کامل API ها**: کاربران vs ادمین
- **میدل‌ور ادمین**: محافظت از API های ادمین

### پیام 4: تحلیل وضعیت فعلی و توسعه سیستم قالب‌ها

#### 🎯 **وضعیت فعلی:**
- **API قوی**: POST /api/events با سیستم قالب‌های ساختاریافته
- **نقاط قوت**: امن، تمیز، کارآمد برای رویدادهای ثابت
- **محدودیت اصلی**: عدم پشتیبانی از گزینه‌های پویا (Dynamic Outcomes)

#### 📋 **مشکل شناسایی شده:**
- **قالب "who will win..."**: نیاز به گزینه‌های تعریف شده توسط کاربر
- **API فعلی**: فقط گزینه‌های ثابت از قالب
- **شکاف**: عدم پشتیبانی از outcomes پویا

#### 🔧 **راه‌حل توسعه:**

##### **تغییر 1: هوشمندسازی EventTemplate**
- **فیلد جدید**: `outcomesStructure: JSONB`
- **FIXED**: `{ "type": "FIXED", "options": ["Yes", "No"] }`
- **DYNAMIC**: `{ "type": "DYNAMIC", "min": 2, "max": 10 }`

##### **تغییر 2: هوشمندسازی API**
- **بررسی outcomesStructure**: قبل از ایجاد رویداد
- **FIXED**: استفاده از گزینه‌های ثابت قالب
- **DYNAMIC**: دریافت outcomes از کاربر + اعتبارسنجی

### پیام 5: جزئیات پیاده‌سازی outcomesStructure

#### 🎯 **ساختار JSONB:**

##### **نوع FIXED:**
```json
{
  "type": "FIXED",
  "options": [
    { "title": "Yes" },
    { "title": "No" }
  ]
}
```

##### **نوع DYNAMIC:**
```json
{
  "type": "DYNAMIC",
  "min": 2,
  "max": 10
}
```

#### 📋 **اعتبارسنجی (Validation):**
- **کلید type**: اجباری
- **FIXED**: کلید options (آرایه آبجکت‌ها) اجباری
- **DYNAMIC**: کلیدهای min و max (اعداد) اجباری
- **API های مدیریت**: POST /api/admin/templates و PUT /api/admin/templates/[id]

#### 🔧 **مدیریت خطا:**
- **خطای 400 Bad Request**: ساختار نامعتبر
- **پیام واضح**: "ساختار گزینه‌ها نامعتبر است"

### پیام 6: اعتبارسنجی outcomes پویا و اولویت‌بندی توسعه

#### 🎯 **اعتبارسنجی outcomes پویا (POST /api/events):**

##### **قوانین اعتبارسنجی:**
1. **وجود کلید**: ورودی کاربر باید حتماً شامل کلید `outcomes` باشد
2. **نوع آرایه**: مقدار `outcomes` باید یک آرایه باشد
3. **تعداد گزینه‌ها**: طول آرایه باید بین `min` و `max` تعریف شده در قالب باشد
4. **محتوای گزینه‌ها**: هر آیتم باید یک رشته (string) غیرخالی باشد
5. **محدودیت طول**: طول هر گزینه نباید از ۱۰۰ کاراکتر بیشتر باشد
6. **عدم تکرار**: گزینه‌ها نباید تکراری باشند

#### 📋 **اولویت‌بندی توسعه:**

##### **اولویت قطعی: تکمیل سیستم قالب‌ها برای کاربران**

**دلایل:**
- **قابلیت اصلی**: سیستم قالب‌ها، قابلیت اصلی پلتفرم برای تولید محتوا توسط کاربران است
- **پایه و اساس**: منطق مدیریت گزینه‌های پویا در API کاربران، قابل استفاده مجدد در API ادمین
- **پیچیدگی کمتر**: کار مشخص و محدود در مقابل قابلیت بزرگتر و پیچیده‌تر فرم آزاد ادمین

### پیام 7: جزئیات UI فرم آزاد ادمین و مدیریت فایل‌ها

#### 🎯 **جزئیات UI فرم آزاد ادمین:**

##### **فیلدهای مورد نیاز:**
1. **عنوان رویداد**: UInput (فیلد متنی ساده)
2. **توضیحات رویداد**: UTextarea با پشتیبانی از Markdown
3. **URL تصویر رویداد**: UInput
4. **URL منبع داوری**: UInput
5. **مهلت شرط‌بندی**: Date/Time Picker
6. **گزینه‌ها (Outcomes)**: بخش پویا با دکمه "+"
   - عنوان گزینه: UInput
   - URL تصویر گزینه: UInput (اختیاری)
7. **تنظیمات اضافی**: UCheckbox برای "ویژه کردن رویداد" (isFeatured)

#### 📋 **مدیریت تصاویر و فایل‌ها:**

##### **رویکرد MVP (روش استاندارد):**
- **عدم پیاده‌سازی سیستم آپلود**: برای حفظ سادگی و سرعت توسعه
- **فیلدهای تصویر**: از نوع STRING (URL)
- **مسئولیت کاربر/ادمین**: آپلود تصاویر در سرویس‌های خارجی (Imgur، فضای ابری)
- **جای‌گذاری URL**: فقط URL تصویر در فیلدهای مربوطه

---

## 🎯 **سوالات کلیدی:**

1. **مشکل خاص چیست که بعداً عنوان خواهد شد؟** ✅ پاسخ داده شد: محدودیت انعطاف‌پذیری ادمین
2. **اهداف اصلی پروژه چیست؟** ✅ پاسخ داده شد: پلتفرم شرط‌بندی با کیفیت بالا
3. **اولویت‌های بعدی کدامند؟** ✅ پاسخ داده شد: تکمیل سیستم قالب‌ها
4. **محدودیت‌های فنی چیست؟** ✅ پاسخ داده شد: عدم پشتیبانی از گزینه‌های پویا

### 🆕 **سوالات جدید:**
5. **جزئیات پیاده‌سازی فرم آزاد ادمین چیست؟** ✅ پاسخ داده شد: فیلدهای مشخص شده
6. **نحوه مدیریت ویرایش رویدادهای کاربران چگونه است؟** ⏳ منتظر پاسخ
7. **ساختار API برای رویدادهای سفارشی چیست؟** ✅ پاسخ داده شد: POST /api/admin/events/create-custom

### 🆕 **سوالات جدید:**
8. **اولویت‌بندی پیاده‌سازی کدام است؟** ✅ پاسخ داده شد: بک‌اند اول، سپس فرانت‌اند
9. **جزئیات UI فرم آزاد ادمین چیست؟** ✅ پاسخ داده شد: فیلدهای مشخص شده
10. **نحوه مدیریت تصاویر و فایل‌ها چگونه است؟** ✅ پاسخ داده شد: رویکرد MVP با URL

### 🆕 **سوالات جدید:**
11. **جزئیات پیاده‌سازی قوانین طلایی چیست؟** ⏳ منتظر پاسخ
12. **نحوه مدیریت ویرایش رویدادهای فعال چگونه است؟** ⏳ منتظر پاسخ
13. **ساختار API ویرایش ادمین چیست؟** ⏳ منتظر پاسخ

### 🆕 **سوالات جدید:**
14. **جزئیات پیاده‌سازی outcomesStructure چیست؟** ✅ پاسخ داده شد: ساختار JSONB
15. **نحوه اعتبارسنجی outcomes پویا چگونه است؟** ✅ پاسخ داده شد: قوانین ۶ گانه
16. **اولویت‌بندی توسعه: قالب‌ها یا فرم آزاد ادمین؟** ✅ پاسخ داده شد: قالب‌ها اولویت قطعی

---

## 📋 **چک‌لیست نهایی:**

- [x] درک کامل از اهداف پروژه
- [x] شناسایی تمام مشکلات
- [x] تعیین اولویت‌ها
- [x] برنامه‌ریزی اقدامات
- [x] مستندسازی تصمیمات

---

## 🚀 **برنامه اقدام نهایی:**

### **مرحله ۱: توسعه سیستم قالب‌ها (اولویت قطعی)** ✅ **تکمیل شده**
1. ✅ **اضافه کردن فیلد `outcomesStructure`** به مدل EventTemplate
2. ✅ **پیاده‌سازی اعتبارسنجی outcomes پویا** در API کاربران
3. ✅ **به‌روزرسانی API های مدیریت قالب‌ها**
4. ✅ **تست و اعتبارسنجی سیستم** (تکمیل شده)

### **مرحله ۲: توسعه API های ادمین** ✅ **تکمیل شده**
1. ✅ **ایجاد API ایجاد رویداد سفارشی** (POST /api/admin/events/create-custom)
2. ✅ **ایجاد API ویرایش رویداد ادمین** (PUT /api/admin/events/[id]/edit)
3. ✅ **پیاده‌سازی قوانین طلایی ویرایش**
4. ✅ **برطرف کردن خطاهای TypeScript**

### **مرحله ۳: توسعه UI فرم آزاد ادمین** ⏳ **در انتظار**
1. **توسعه UI فرم آزاد**
2. **پیاده‌سازی قوانین طلایی در فرانت‌اند**
3. **تست و اعتبارسنجی**

---

## 🆕 **API های جدید پیاده‌سازی شده:**

### **1. API ایجاد رویداد سفارشی ادمین**
- **مسیر**: `POST /api/admin/events/create-custom`
- **توضیحات**: ادمین می‌تواند رویدادهای سفارشی بدون استفاده از قالب ایجاد کند
- **فیلدهای ورودی**:
  - `title`: عنوان رویداد (اجباری)
  - `description`: توضیحات رویداد
  - `bettingDeadline`: مهلت شرط‌بندی (اجباری)
  - `outcomes`: آرایه‌ای از رشته‌ها (حداقل ۲ گزینه)
  - `imageUrl`: URL تصویر رویداد (اختیاری)
  - `resolutionSourceUrl`: URL منبع داوری (اختیاری)
  - `isFeatured`: ویژه کردن رویداد (اختیاری)
- **ویژگی‌ها**:
  - `isCustom: true` برای تمام رویدادهای ایجاد شده
  - `status: 'ACTIVE'` به صورت پیش‌فرض
  - محافظت شده توسط میدل‌ور ادمین

### **2. API ویرایش رویداد ادمین**
- **مسیر**: `PUT /api/admin/events/[id]/edit`
- **توضیحات**: ویرایش رویدادها با قوانین طلایی بر اساس وضعیت
- **قوانین طلایی**:
  - **PENDING_APPROVAL**: ویرایش کامل مجاز (عنوان، توضیحات، مهلت، گزینه‌ها)
  - **ACTIVE**: فقط فیلدهای غیرحیاتی (تصویر، ویژه)
  - **سایر وضعیت‌ها**: غیرقابل ویرایش
- **ویژگی‌ها**:
  - تبدیل خودکار به `isCustom: true`
  - به‌روزرسانی گزینه‌ها در صورت ارائه
  - محافظت شده توسط میدل‌ور ادمین

### **3. بهبود API ایجاد رویداد کاربران**
- **مسیر**: `POST /api/events`
- **تغییرات جدید**:
  - پشتیبانی از `outcomesStructure.type === 'DYNAMIC'`
  - اعتبارسنجی پیشرفته outcomes پویا
  - پشتیبانی از ورودی `string[]` و `Array<{ title: string }>`
- **قوانین اعتبارسنجی outcomes پویا**:
  - وجود کلید outcomes
  - نوع آرایه
  - تعداد بین min و max
  - محتوای غیرخالی
  - محدودیت طول (۱۰۰ کاراکتر)
  - عدم تکرار

### **4. قالب‌های جدید تست**
- **قالب "Competition (Who will win?)"**: outcomesStructure.type = 'DYNAMIC', min: 2, max: 10
- **قالب "Numerical Prediction"**: outcomesStructure.type = 'DYNAMIC', min: 2, max: 5
- **قالب "Crypto Price Prediction"**: outcomesStructure.type = 'FIXED' (بله/خیر)

---

## 📊 **وضعیت فعلی پروژه:**

### ✅ **تکمیل شده‌ها:**
- سیستم قالب‌های پویا برای کاربران
- API های ادمین برای ایجاد و ویرایش رویدادها
- قوانین طلایی ویرایش
- اعتبارسنجی پیشرفته outcomes
- برطرف کردن تمام خطاهای TypeScript

### ⏳ **در انتظار:**
- توسعه UI فرم آزاد ادمین
- تست‌های نهایی و بهینه‌سازی

---

*این فایل در طول گفتگو به‌روزرسانی خواهد شد...*
